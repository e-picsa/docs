# Device Testing

### Getting Started

The guide below assumes some knowledge or running android projects locally using Android Studio.

As a minimum you will need [Android Studio](https://developer.android.com/studio) installed, and a virtual or physical device connected.
More information can be found in the [Android Studio Documentation](https://developer.android.com/studio/run)

You will also need to populate a relevant `google-services.json` file, available from project admin.

### Running on a device

In order to run a local app on a native (or emulator) device with live-reload support both the device and local server need custom configuration.
A utility script is included to help automate this process

```sh
yarn nx run picsa-apps-extension-app-native:serve
```

This will first create a custom build of the code with set to look for code served at the device external address `http://0.0.0.0:4200`,
and then also instruct the angular compiler to serve code available at the same address.

Run the app from android studio either on an emulator or physical device

The app should live reload both on local network and device

**Wireless Debugging**
The above method will only work if the device is physically connected to the same computer running the development server.
If using wireless debugging you will need to additionally specify your own local adapter IP address. This should usually be in the form:
`192.xxx.xx.xx`

Create an environment variable override file `apps/picsa-apps/extension-app-native/.env.local`, and provide as a `SERVER_URL` variable with the full url, e.g.

```sh
SERVER_URL=http://192.xxx.xx.xx:4200
```

On windows you can check your ip via `ip config` and look for `IPv4` address for your internet adapter

### Inspecting Logs

Logs will appear in Android Studio logcat, or can be viewed in google chrome using the device inspector

`chrome://inspect/#devices`

![](./images/chrome-device-inspector.png)

Clicking on _inspect_ will launch devtools with access to full console logs

![](./images/chrome-device-inspector-2.png)

### Troubleshooting

Main common issues are outlined in the Capacitor Android Documentation:
https://capacitorjs.com/docs/android

There is also a dedicated troubleshooting page available at:
https://capacitorjs.com/docs/android/troubleshooting

A few other specific issues are outlined below:

#### Android Emulator Crashes

If the emulator is crashing during operation view the android studio logcat logs and try to debug error messages on stackoverflow.

If the emulator crashes during startup (with no log messages shown) recommended troubelshooting steps:

- Ensure you have the latest version of the emulator SDK installed from Android Studio
- Try running emulator from command line with verbose logging and without Vulkan UI

```sh
 emulator -avd "Pixel_API_33" -verbose -show-kernel -feature -Vulkan
```

- Review troubleshooting advice at: https://developer.android.com/studio/run/emulator-troubleshooting
- Review issues raised at: https://issuetracker.google.com/issues?q=componentid:192727

#### Webcomponents

There may be issue bundling webcomponents when running on device server.
The current workaround is simply to temporarily disable the custom elements, by commenting out the `defineCustomElements` declarations

```ts {4,8} showLineNumbers filename="libs/webcomponents-ngx/src/lib/webcomponents-ngx.module.ts"
import { CommonModule } from "@angular/common";
import { NgModule } from "@angular/core";
// Import and register all custom elements for the module
// import { defineCustomElements } from '@picsa/webcomponents/loader';

import { DIRECTIVES } from "./generated";

// defineCustomElements(window);

@NgModule({
  imports: [CommonModule],
  declarations: [...DIRECTIVES],
  exports: [...DIRECTIVES],
})
export class WebcomponentsNgxModule {}
```
